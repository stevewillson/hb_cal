<% //debugger %>
<%

var weekday = new Array(7)
weekday[0] = 'S'
weekday[1] = 'M'
weekday[2] = 'T'
weekday[3] = 'W'
weekday[4] = 'T'
weekday[5] = 'F'
weekday[6] = 'S'

// check for cookie values to set an arbitrary start and stop date, and cell_width
try {
  var calStartDate = new Moment(calView.startDate)
  if (!calStartDate.isValid()) throw new Error('Invalid Date: calStartDate')
  if (calView.startDate === undefined) throw new Error('startDate undefined')
} catch (err) {
  calStartDate = new Moment()
}

try {
  var calEndDate = new Moment(calView.endDate)
  if (!calEndDate.isValid()) throw new Error('Invalid Date: calEndDate')
  if (calView.endDate === undefined) throw new Error('endDate undefined')
  if (calEndDate.isSame(calStartDate)) throw new Error('endDate same as startDate')
} catch (err) {
  calEndDate = calStartDate.clone().add(30, 'days')
}

try {
  var cellWidth = calView.cellWidth
  if (cellWidth === undefined) throw new Error('cellWidth is undefined')
  if (isNaN(cellWidth)) throw new Error('cellWidth is NaN')
  if (cellWidth === '') throw new Error('cell_width is empty')
} catch (err) {
  cellWidth = 50
}

var curCat = ''
var prevCat = ''
var hbCatIndex = 0
// make an array of the events that are passed, group the events by category
var hbEvents = []
hbEvents[hbCatIndex] = []

// events are retrieved from the database in category and then date order
// iterate through all of the events and put them in the array
for (var i = 0; i < events.events.length; i++) {
  curCat = events.events[i].category

  // check if the categories are different AND the iterator is not the first event, then make a new row
  if (curCat !== prevCat && i !== 0) {
    hbCatIndex++
    hbEvents[hbCatIndex] = []
  }

  hbEvents[hbCatIndex].push(events.events[i])

  // at the end of the loop, update prev_cat with the value of cur_cat
  prevCat = curCat
}

// after this loop, the events are divided into groups based on category.

function drawEvent (event) {
  // for each event retrieved from the database, draw them on the table
  // events should be drawn in the proper location for the proper row
  // determine top offsets for the rows
  // determine how far over to draw the events

  var eventCell = ''
  var eventCellOffset = ''
  var eventStartDate = new Moment(event.eventStartDate)
  var eventEndDate = new Moment(event.eventEndDate)

  var eventLength = eventEndDate.diff(eventStartDate, 'days') + 1
  var viewLength = calEndDate.diff(eventStartDate, 'days') + 1
  var dispLength = Math.min(eventLength, viewLength)

  var eventCellWidth = dispLength * cellWidth

  // TODO need to properly adjust the height of the cell as well as the width of the cell

  var eventOffset = eventStartDate.diff(calStartDate, 'days') + 1

  eventCellOffset = (cellWidth * 2) + (cellWidth * eventOffset)

  // event_cell += '<div style="position: absolute; width: ' + event_cell_width +'px; height: 20px; left: REPLACE WITH HOW FAR LEFT; top: REPLACE WITH HOW FAR FROM TOP;';
  eventCell += '<div style="position: absolute; width: ' + eventCellWidth + 'px; height: 20px; left: ' + eventCellOffset + 'px; top: 200px;" >'
  eventCell += '<td class = "' + event.eventType + '" colspan = "' + dispLength + '" style="width: ' + cellWidth * dispLength + 'px; height: 30px; border: 1px solid black;">\n'
  eventCell += '<form name="delevent" method="post" action="./delevent"><input type="hidden" name="documentid" '
  eventCell += 'value="' + event._id + '"><button class="linkButton" type="submit">'
  eventCell += event.eventSummary
  eventCell += '</button></form>\n'
  eventCell += '</td>\n'
  eventCell += '</div>\n'

  return eventCell
}

function drawEmptyRow (rowName) {
  // add the left most cell, this is the event category
  var emptyRow = ''
  var curDay = new Moment().startOf('days')
  emptyRow += '<tr data-resource-id="' + rowName + '">'
  emptyRow += '<td style="width: ' + cellWidth * 2 + 'px;">\n'
  emptyRow += rowName
  emptyRow += '</td>\n'

  for (var m = new Moment(calStartDate).startOf('days'); m.diff(calEndDate, 'days') <= 0; m.add(1, 'days')) {
    var cellStyle = ''
    if (m.isSame(curDay, 'day')) {
      cellStyle += 'background-color: #AAAAAA;'
    }
    // write a cell and move on
    emptyRow += '<td colspan = "1" ' + 'px;" data-date="' + m.format('YYYY-MM-DD') + '" style="width: ' + cellWidth + 'px; ' + cellStyle + '">\n'
    emptyRow += '</td>\n'
  }
  // done with the m day iteration, add ending values to the row and then return the row value
  emptyRow += '</tr>'
  return emptyRow
}

var hbCalTable = '<div class="hb_cal">'

var tableWidth = cellWidth * (calEndDate.diff(calStartDate, 'days') + 2)
hbCalTable += '<table id="hb_table" class="hb_table" style="width: ' + tableWidth + 'px; table-layout: fixed;">'

var headerRow = ''
headerRow += '<tr>'

// make the first column
headerRow += '<th class="hb_header" data-category="top column" style="width: ' + cellWidth * 2 + 'px;">\n'
headerRow += 'Category\n'
headerRow += '</th>\n'

// draw additional columns, will be end date - start date columns wide
for (var m = new Moment(calStartDate).startOf('days'); m.diff(calEndDate, 'days') <= 0; m.add(1, 'days')) {
  // for the header row, display the date number and the day of the week
  var d = m.date()
  var n = weekday[m.day()]
  var curDay = Moment().startOf('days')

  // highlight the current day in the top
  var cellStyle = ''
  if (m.isSame(curDay, 'days')) {
    cellStyle += 'background-color: #AAAAAA;'
  }

  headerRow += '<th class="hb_header" data-date="' + m.format('YYYY-MM-DD') + ' style="width: ' + cellWidth + 'px;" style="' + cellStyle + '">\n'
  headerRow += d + ' ' + n + '\n'
  headerRow += '</th>\n'
}

headerRow += '</tr>'
hbCalTable += headerRow

// loop through the categories to add a row for each category on the table, use the 'draw_row' function to add a row to the html table
for (var catIter = 0; catIter < hbEvents[0].length; catIter++) {
  hbCalTable += drawEmptyRow(hbEvents[0][catIter].eventCategory)
}
hbCalTable += '</table>'

var eventCell = ''
for (var eventIter = 0; eventIter < hbEvents[0].length; eventIter++) {
  eventCell += drawEvent(hbEvents[0][eventIter])
}

hbCalTable += eventCell
hbCalTable += '</div>'

%>
<%- hbCalTable %>
